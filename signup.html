<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Регистрация</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<header>
  <div class="header-inner">
    <h1>Регистрация</h1>
    <nav class="top-nav">
      <a href="index.html" class="top-btn">Начало</a>
    </nav>
  </div>
</header>

<section class="signup-hero">
  <h2>Създай своя акаунт</h2>
</section>

<div class="centered-card signup-container">
  <form id="signupForm">
    <input type="text" placeholder="Потребителско име" id="signupUsername" required>
    <input type="email" placeholder="Имейл" id="signupEmail" required>
    <input type="password" placeholder="Парола" id="signupPassword" required>
    <input type="password" placeholder="Повтори паролата" id="signupConfirmPassword" required>
    <button type="submit" class="modal-submit">Регистрация</button>
    <p class="muted">Вече имате акаунт? <a href="index.html" class="accent">Начало</a></p>
  </form>
</div>

<script type="module">
const signupForm = document.getElementById('signupForm');
const API_URL = 'https://my-backend.martinmiskata.workers.dev';

// Toast function
function showToast(msg, duration = 3000) {
  const t = document.createElement('div');
  t.textContent = msg;
  t.style.position = 'fixed';
  t.style.right = '28px';
  t.style.bottom = '28px';
  t.style.padding = '12px 16px';
  t.style.background = '#111827';
  t.style.color = '#fff';
  t.style.borderRadius = '10px';
  t.style.boxShadow = '0 8px 30px rgba(2,6,23,0.4)';
  document.body.appendChild(t);
  setTimeout(() => document.body.removeChild(t), duration);
}

signupForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const usernameInput = document.getElementById('signupUsername').value.trim();
  const emailInput = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPassword').value;
  const confirm = document.getElementById('signupConfirmPassword').value;

  if (password !== confirm) {
    showToast('Паролите не съвпадат!');
    return;
  }

  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;
  if (!emailRegex.test(emailInput)) {
    showToast('Моля, въведете валиден имейл');
    return;
  }

  const allowedDomains = ["gmail.com", "yahoo.com", "outlook.com", "hotmail.com"];
  const domain = emailInput.split("@")[1];
  if (!allowedDomains.includes(domain)) {
    showToast('Моля, използвайте валиден имейл (gmail, yahoo, outlook...)');
    return;
  }

  try {
    // Check availability
    const checkRes = await fetch(`${API_URL}/check-availability`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, email: emailInput })
    });
    const checkData = await checkRes.json();

    if (checkData.usernameTaken) {
      showToast('Потребителското име вече е заето!');
      return;
    }
    if (checkData.emailTaken) {
      showToast('Имейлът вече е регистриран!');
      return;
    }

    // Signup
    const res = await fetch(`${API_URL}/signup`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: usernameInput, email: emailInput, password })
    });
    const data = await res.json();

    if (data.success) {
      showToast('Успешна регистрация! Можете да влезете с акаунта си.');
      signupForm.reset();
      setTimeout(() => window.location.href = 'index.html', 900);
    } else {
      showToast(data.message || 'Грешка при регистрация');
    }

  } catch (err) {
    showToast('Грешка при регистрация');
    console.error(err);
  }
});
</script>

</body>
</html>
