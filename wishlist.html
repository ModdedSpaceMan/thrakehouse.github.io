<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ—é–±–∏–º–∏ –∏–º–æ—Ç–∏</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header-inner">
    <h1>–õ—é–±–∏–º–∏ –∏–º–æ—Ç–∏</h1>
    <nav class="top-nav">
      <a href="index.html" class="top-btn">–ù–∞—á–∞–ª–æ</a>
      <a href="wishlist.html" class="top-btn">–õ—é–±–∏–º–∏</a>
    </nav>
  </header>

  <main>
    <section id="wishlistProperties" class="properties"></section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { showToast } from './ui.js';

    const API_URL = 'https://my-backend.martinmiskata.workers.dev';
    const username = localStorage.getItem('username');
    const token = localStorage.getItem('token');
    const propertyContainer = document.getElementById('wishlistProperties');

    let wishlistIds = [];

    // Fetch wishlist from server
    async function loadWishlist() {
      if (!username || !token) {
        propertyContainer.innerHTML = '<p>–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏, –∑–∞ –¥–∞ –≤–∏–¥–∏—Ç–µ –ª—é–±–∏–º–∏—Ç–µ –∏–º–æ—Ç–∏.</p>';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/wishlists/${username}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        wishlistIds = data.items || [];

        // Fetch all properties to filter valid ones
        const propsRes = await fetch(`${API_URL}/properties`);
        const allProperties = await propsRes.json();
        const validProperties = allProperties.filter(p => wishlistIds.includes(p.id));

        renderWishlist(validProperties);
      } catch (err) {
        console.error(err);
        propertyContainer.innerHTML = '<p>–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ª—é–±–∏–º–∏—Ç–µ –∏–º–æ—Ç–∏.</p>';
      }
    }

    // Render wishlist
    function renderWishlist(properties) {
      if (!properties.length) {
        propertyContainer.innerHTML = '<p>–ù—è–º–∞—Ç–µ –ª—é–±–∏–º–∏ –∏–º–æ—Ç–∏.</p>';
        return;
      }

      propertyContainer.innerHTML = properties.map(p => {
        const inWishlist = wishlistIds.includes(p.id) ? '‚ù§Ô∏è' : 'ü§ç';
        return `
          <div class="property" data-id="${p.id}">
            ${p.image ? `<img src="${p.image}" alt="${p.name}">` : ''}
            <div class="property-content">
              <h3>${p.name}</h3>
              <p>–õ–æ–∫–∞—Ü–∏—è: ${p.location}</p>
              <p>–¶–µ–Ω–∞: ${p.price}</p>
              <p>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${p.category === 'rental' ? '–ù–∞–µ–º' : '–ü—Ä–æ–¥–∞–∂–±–∞'}</p>
              <p>–¢–∏–ø: ${p.type}</p>
            </div>
            <button class="wishlist-btn" data-id="${p.id}">${inWishlist}</button>
          </div>
        `;
      }).join('');

      addWishlistListeners();
    }

    // Wishlist toggle
    async function toggleWishlist(propertyId) {
      if (!username || !token) {
        showToast('–¢—Ä—è–±–≤–∞ –¥–∞ —Å—Ç–µ –≤–ª–µ–∑–ª–∏!');
        return;
      }

      const action = wishlistIds.includes(propertyId) ? 'remove' : 'add';
      try {
        const res = await fetch(`${API_URL}/wishlists/${username}/${action}`, {
          method: 'POST',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ propertyId })
        });
        const data = await res.json();
        if (data.success) {
          if (action === 'add') wishlistIds.push(propertyId);
          else wishlistIds = wishlistIds.filter(id => id !== propertyId);

          showToast(action === 'add' ? '–î–æ–±–∞–≤–µ–Ω–æ –≤ wishlist!' : '–ü—Ä–µ–º–∞—Ö–Ω–∞—Ç–æ –æ—Ç wishlist');
          await loadWishlist();
        } else {
          showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–º—è–Ω–∞ –Ω–∞ –ª—é–±–∏–º–∏—Ç–µ');
        }
      } catch (err) {
        console.error(err);
        showToast('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—Ä—ä–∑–∫–∞ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞');
      }
    }

    // Add button listeners
    function addWishlistListeners() {
      propertyContainer.querySelectorAll('.wishlist-btn').forEach(btn => {
        btn.addEventListener('click', e => {
          e.stopPropagation();
          toggleWishlist(btn.dataset.id);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', loadWishlist);
  </script>
</body>
</html>
